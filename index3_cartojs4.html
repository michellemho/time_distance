<!DOCTYPE html>
<html>
  <head>
    <title>Travel Times | CARTO</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <!-- Include Leaflet -->
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
    <link href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" rel="stylesheet">
    <!-- Include CARTO.js -->
    <script src="https://cartodb-libs.global.ssl.fastly.net/carto.js/v4.0.0-beta.10/carto.min.js"></script>
    <!-- Fonts -->
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700' rel='stylesheet' type='text/css'>
    <style>
      * { margin:0; padding:0; }
      html { box-sizing:border-box; height:100%; }
      body { background:#f2f6f9; height:100%; font-family:"Open sans", Helvetica, Arial, sans-serif; }
      #container { display:flex; width:100%; height:100%; }
      #map { flex:1; margin:10px; }
      #widgets { width:300px; margin:10px 10px 10px 0; }
      .widget { background:white; padding:10px; margin-bottom:10px; }
      .widget h1 { font-size:1.2em; }
      .widget-formula .result { font-size:2em; }
    </style>
  </head>
  <body>
    <div id="container">
      <div id="map"></div>
      <div id="widgets">
        <div id="avgRandomNumWidget" class="widget widget-formula">
          <h1>Average time</h1>
          <p><span class="js-average-nums result">xxx</span> minutes</p>
        </div>
      </div>
    </div>
    <script>
      const map = L.map('map').setView([40.704301, -73.936658], 10);
      // Adding Voyager Basemap
      L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}.png', {
        maxZoom: 18
      }).addTo(map);

      // Adding Voyager Labels
      L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_only_labels/{z}/{x}/{y}.png', {
        maxZoom: 18,
        zIndex: 10
      }).addTo(map);

      var client = new carto.Client({
        apiKey: 'my_api_key',
        username: 'michellemho-carto'
      });

      const time_duration_dataset = new carto.source.SQL(`
        SELECT durations_to_areas.* , round(t1.time,2) as time FROM durations_to_areas, (SELECT generate_series(1,2181) as cartodb_id,  unnest(times_car::numeric[])::numeric as time FROM durations_to_areas WHERE durations_to_areas.name = 34003002100) as t1 Where durations_to_areas.cartodb_id = t1.cartodb_id
      `);
      const time_duration_style = new carto.style.CartoCSS(`
        #layer {
          polygon-fill: ramp([time], (#008080, #70a494, #b4c8a8, #f6edbd, #edbb8a, #de8a5a, #ca562c), quantiles);
        }
        #layer::outline {
          line-width: 1;
          line-color: #FFFFFF;
          line-opacity: 0.5;
        }
      `);

      const durations_to_areas = new carto.layer.Layer(time_duration_dataset, time_duration_style, {featureOverColumns: ['time']});


      client.addLayers([durations_to_areas]);
      client.getLeafletLayer().addTo(map);

      // create a hover over popup
      const popup = L.popup({ closeButton: false });

      durations_to_areas.on('featureOver', featureEvent => {
        console.log(`Mouse over shape with time: ${featureEvent.data.time}`);
      });

      durations_to_areas.on(carto.layer.events.FEATURE_OVER, featureEvent => {
        popup.setLatLng(featureEvent.latLng);
        popup.setContent(`${Math.round(featureEvent.data.time/60*100/100)} minutes`);
        popup.openOn(map);
      });
      //
      durations_to_areas.on('featureOut', featureEvent => {
          popup.removeFrom(map);
        });

      // Adding a formula widget
      const averageRandomNum = new carto.dataview.Formula(time_duration_dataset, 'time', {
        operation: carto.operation.AVG
      });

      averageRandomNum.on('dataChanged', data => {
        refreshAverageNumWidget(data.result);
      });

      function refreshAverageNumWidget(avgRandomNum) {
        const widgetDom = document.querySelector('#avgRandomNumWidget');
        const averageRandomNumDom = widgetDom.querySelector('.js-average-nums');
        averageRandomNumDom.innerText = Math.round(avgRandomNum/60 * 100) / (100) ;
      }

      client.addDataview(averageRandomNum);


    </script>
  </body>
</html>
