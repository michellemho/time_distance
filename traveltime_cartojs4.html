<!DOCTYPE html>
<html>
  <head>
    <title>Travel Times | CARTO</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <!-- Include Leaflet -->
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
    <link href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" rel="stylesheet">
    <!-- Include CARTO.js -->
    <script src="https://cartodb-libs.global.ssl.fastly.net/carto.js/v4.0.0-beta.10/carto.min.js"></script>
    <!-- Fonts -->
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700' rel='stylesheet' type='text/css'>
    <style>
      * { margin:0; padding:0; }
      html { box-sizing:border-box; height:100%; }
      body { background:#f2f6f9; height:100%; font-family:"Open sans", Helvetica, Arial, sans-serif; }
      #container { display:flex; width:100%; height:100%; }
      #map { flex:1; margin:10px; }
      #widgets { width:300px; margin:10px 10px 10px 0; }
      .widget { background:white; padding:10px; margin-bottom:10px; }
      .widget h1 { font-size:1.2em; }
      .widget-formula .result { font-size:2em; }
    </style>
  </head>
  <body>
    <div id="container">
      <div id="map"></div>
      <div id="widgets">
        <div id="avgOfTimeWidget" class="widget widget-formula">
          <h1>Average time</h1>
          <p><span class="js-average-nums result">xxx</span> minutes</p>
        </div>
        <div class="widget widget-histogram" id="widgetHistogram"></div>
      </div>
    </div>
    <script>
      const map = L.map('map').setView([40.782901, -73.9658], 12);
      // Adding Voyager Basemap
      L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/dark_nolabels/{z}/{x}/{y}.png', {
        minZoom: 0
      }).addTo(map);

      // Adding Voyager Labels
      L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_only_labels/{z}/{x}/{y}.png', {
        minZoom: 0,
        zIndex: 10
      }).addTo(map);

      var client = new carto.Client({
        apiKey: 'my_api_key',
        username: 'michellemho-carto'
      });

      var time_duration_dataset = new carto.source.SQL(`
        SELECT durations_to_areas.* , round(t1.time,2) as time
        FROM durations_to_areas,
          (SELECT generate_series(1,2181) as cartodb_id,
                  unnest(times_car::numeric[])::numeric as time
           FROM durations_to_areas
           WHERE durations_to_areas.name = 36061014300) as t1
        WHERE durations_to_areas.cartodb_id = t1.cartodb_id
      `);
      const time_duration_style = new carto.style.CartoCSS(`
        #layer{
          polygon-fill: ramp([time],
            (#f7feae,#b7e6a5,#7ccba2,#46aea0,#089099,#00718b,#045275), quantiles);
        }
        #layer::outline {
          line-width: 0;
          line-color: #FFFFFF;
          line-opacity: 0.5;
        }
        #layer[name=36061014300]{
          polygon-fill: #dd1c77;
        }
      `);

      var durations_to_areas = new carto.layer.Layer(time_duration_dataset, time_duration_style, {featureOverColumns: ['time','name']});


      client.addLayers([durations_to_areas]);
      client.getLeafletLayer().addTo(map);

      // create a hover over popup
      const popup = L.popup({ closeButton: false });

      durations_to_areas.on('featureOver', featureEvent => {
        // console.log(featureEvent.data.time);
      });

      durations_to_areas.on(carto.layer.events.FEATURE_OVER, featureEvent => {
        popup.setLatLng(featureEvent.latLng);
        popup.setContent(`${Math.round(featureEvent.data.time/60*100/100)} minutes`);
        popup.openOn(map);
      });
      //
      durations_to_areas.on('featureOut', featureEvent => {
          popup.removeFrom(map);
        });

      durations_to_areas.on('featureClicked', featureEvent => {
        map.setView(featureEvent.latLng);
        console.log('feature clicked!');
        console.log(featureEvent.data.name)
        time_duration_dataset.setQuery(`
          SELECT durations_to_areas.* , round(t1.time,2) as time
          FROM durations_to_areas,
            (SELECT generate_series(1,2181) as cartodb_id,
                    unnest(times_car::numeric[])::numeric as time
             FROM durations_to_areas
             WHERE durations_to_areas.name = ${featureEvent.data.name}) as t1
          WHERE durations_to_areas.cartodb_id = t1.cartodb_id
          AND time <> 0
        `);
        time_duration_style.setContent(`
            #layer{
              polygon-fill: ramp([time],
                (#f7feae,#b7e6a5,#7ccba2,#46aea0,#089099,#00718b,#045275), quantiles);
            }
            #layer::outline {
              line-width: 0;
              line-color: #FFFFFF;
              line-opacity: 0.5;
            }
            #layer[name=${featureEvent.data.name}]{
              polygon-fill: #dd1c77;
            }
          `)

        });

      ///////////////////////////
      //Adding a formula widget//
      ///////////////////////////
      const averageOfTime = new carto.dataview.Formula(time_duration_dataset, 'time', {
        operation: carto.operation.AVG
      });

      averageOfTime.on('dataChanged', data => {
        refreshAverageNumWidget(data.result);
      });

      function refreshAverageNumWidget(avgOfTime) {
        const widgetDom = document.querySelector('#avgOfTimeWidget');
        const averageOfTimeDom = widgetDom.querySelector('.js-average-nums');
        averageOfTimeDom.innerText = Math.round(avgOfTime/60 * 100) / (100) ;
      }

      client.addDataview(averageOfTime);

    </script>
  </body>
</html>
