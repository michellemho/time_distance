<!DOCTYPE html>
<html>
<head>
<title>Office Move | CARTO</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta charset="UTF-8">
 <!-- Include CARTO VL JS -->
<script src="https://cartodb.github.io/carto-vl/dist/carto-vl.js"></script>
 <!-- Include Mapbox GL JS -->
<script src="https://libs.cartocdn.com/mapbox-gl/v0.48.0-carto1/mapbox-gl.js"></script>
<!-- Include Mapbox GL CSS -->
<link href="https://libs.cartocdn.com/mapbox-gl/v0.48.0-carto1/mapbox-gl.css" rel="stylesheet" />
<link href="https://carto.com/developers/carto-vl/examples/maps/style.css" rel="stylesheet">	
</head>
<body>
<div id="map"></div>
<aside class="toolbox">
<div class="box">
<header>
  <h1>Where to Move</h1>
</header>
<section>

  <h2 class="description open-sans" style="font-weight: bold ; font-size: 18px">L Train Shutdown? <br> Time to Move!</h1>
  <p class="description open-sans" style="font-size: 12px ; text-align: left ; line-height: 14px">
  This project is about finding the best location for CARTO's new office move. I used <a href="http://www.opentripplanner.org" target="_blank">OpenTripPlanner</a>, an open source multi-modal router, to calculate isochrones in 10 minute increments  up to 90 minutes from each of our home locations on a transit network based on MTA, LIRR, Metro-North, and PATH GTFS data and OpenStreetMap data*. I removed all Manhattan L stops from the network to simulate the L train shutdown scheduled for 2019.
  </p>
  <p class="description open-sans" style="font-size: 12px ; text-align: left ; line-height: 14px">
  Next, I layered the isochrones over a rectangular grid and filtered out the cells where we don't all overlap. I then summed our commute times for the remaining cells and voil√†, we have the resulting map!
  </p>
  <p class="description open-sans" style="font-size: 12px ; text-align: left ; line-height: 14px">
  The very <b>BEST LOCATION</b> for our new CARTO office is <b>just south of Fort Greene near Atlantic Terminal!</b> An office there will give us an average commute time of about 40 minutes for a grand total of 720 minutes!
  </p>
  <p class="description open-sans" style="font-size: 10px ; text-align: left ; line-height: 14px">
  * Sorry to my co-workers in Massachusetts and Pennsylvania. I assumed you guys "live" in Penn Station for simplicity's sake :) Amtrak, T, SEPTA, and NJ Transit GTFS can be incorporated soon...
  </p>
  <br>
  <h2 class="description open-sans"></h2>
       <div id="controls">
         <ul class="actions">
           <li>
             <input type="radio" name="source" onclick="setWithL()" checked>
             <label style="font-family:Arial">With the L Train</label>
           </li>
           <li>
             <input type="radio" name="source" onclick="setWithOutL()">
             <label style="font-family:Arial">Without the L Train</label>
           </li>
         </ul>
</section>
<footer class="js-footer"></footer>
</div>
</aside>
<div id="loader">
<div class="CDB-LoaderIcon CDB-LoaderIcon--big">
<svg class="CDB-LoaderIcon-spinner" viewBox="0 0 50 50">
  <circle class="CDB-LoaderIcon-path" cx="25" cy="25" r="20" fill="none"></circle>
</svg>
</div>
</div>
<script>
const map = new mapboxgl.Map({
container: 'map',
style: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
center: [-73.95, 40.7],
zoom: 10,
scrollZoom: true,
dragRotate: false,
touchZoomRotate: false,
});

// Define user
carto.setDefaultAuth({
user: 'michellemho-carto',
apiKey: 'bVXxOpTlQFQKmqkuKBRPTA'
});

// Define pop-up
const popup = new mapboxgl.Popup({
  closeButton: false,
  closeOnClick: false
});

const s = carto.expressions;

// Define layer
const noLsource = new carto.source.SQL('SELECT *, sum_time/60 as total_time, sum_time/60/18 as average_time FROM rect_grid_extended WHERE COUNT = 20');

const withLsource = new carto.source.SQL('SELECT *, sum_time/60 as total_time, sum_time/60/18 as average_time FROM "michellemho-carto".rect_grid WHERE count = 18');

const subwayroutes = new carto.source.Dataset('routes_nyc_subway_jan2017')
const subwayviz = new carto.Viz(`
color: ramp(buckets($_group,['JZ','BDFM','S','7','ACE','123','456','NQRW','L','G','SIR']),
[#996633,#FF6319,#808183,#B933AD,#2850AD,#EE352E,#00933C,#FCCC0A,#A7A9AC,#6CBE45,#053159,#FFFFFF])
width: 3
`)

const subwaylayer = new carto.Layer('subway_layer', subwayroutes, subwayviz);


const vizString = `@total_time: $total_time
color: opacity(ramp(linear($total_time, globalMin($total_time), globalMax($total_time)), reverse(CB_RDYLGN)),1-(($total_time-globalMin($total_time))/(globalMax($total_time)-globalMin($total_time))))
strokeWidth: 0.5
strokeColor: opacity(ramp(linear($total_time, globalMin($total_time), globalMax($total_time)), reverse(CB_RDYLGN)),1-(($total_time-globalMin($total_time))/(globalMax($total_time)-globalMin($total_time))))`

const viz = new carto.Viz(vizString);

const gridlayer = new carto.Layer('gridlayer', withLsource, viz);

gridlayer.addTo(map, 'watername_ocean');


subwaylayer.addTo(map,'watername_ocean')
subwaylayer.on('loaded', hideLoader);


function hideLoader() {
document.getElementById('loader').style.opacity = '0';
}

// Define interactivity
 const interactivity = new carto.Interactivity(gridlayer);
 const delay = 50;

 function updatePopup(event) {
  if (event.features.length > 0) {
    const vars = event.features[0].variables;
    popup.setHTML(`
    <div>
      <span style='font-weight: bold'> Total Commute Time: </span> ${vars.total_time.value}
    </div>
    `);
    popup.setLngLat([event.coordinates.lng, event.coordinates.lat]);
    if (!popup.isOpen()) {
      popup.addTo(map);
    }
  } else {
    popup.remove();
  }
}

function setPopupsHover() {
   interactivity.off('featureClick', updatePopup);
   interactivity.on('featureHover', updatePopup);
 }

 setPopupsHover()

 function setWithL() {
  gridlayer.update(withLsource, viz);
}
function setWithOutL() {
  gridlayer.update(noLsource, viz);
}

</script>
</body>
</html>
<!DOCTYPE html>
<html>
  <head>
    <title>Michelle | Adapting Travel Time Map</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <link rel="shortcut icon" href="https://dl.dropboxusercontent.com/u/8139153/favicon.ico" />
    <style>
      html, body, #map {
        height: 100%;
        padding: 0;
        margin: 0;
      }

      .layer_selector {
                background: #FFFFFF;
                border-radius: 4px;
                padding: 0;
                border: 1px solid #999;
                width: 75px;
                box-shadow: rgba(0, 0, 0, 0.2) 0 0 4px 2px;
                font: 22px 'Helvetica';
                position: absolute;
                right: 20px;
                bottom: 25%;
                text-align: center;
            }

            .layer_selector > p {
                font-weight: bold;
                color: #666666;
                padding: 14px 14px 12px 14px;
                cursor: pointer;
                border-bottom: 1px solid #999;
            }

            .layer_selector ul {
                padding: 0px 0px 0px 0px;
                margin: 0;
                list-style-type: none;
                bottom: 0px;
                border-radius: 0px;
            }
            .layer_selector li {
                font-weight: bold;
                padding: 0px;
                font-size: 22px;
                color: #000000;
                cursor: pointer;
                border-bottom: 1px solid #999;
            }
            .layer_selector li:hover {
                background-color: #A9A9A9;
                cursor: pointer;
            }
            .layer_selector li.selected {
                background-color: #A9A9A9;
            }
    </style>
    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.12/themes/css/cartodb.css" />
    <!--[if lte IE 8]>
      <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.ie.css" />
    <![endif]-->
  </head>
  <body>
    <div id="map"></div>

    <div id="layers" class="layer_selector">
        <ul>
            <li data="car" class="selected">car
            </li>
            <li data="bike">bike
            </li>
        </ul>
    </div>

    <!-- using old version of cartodb.js library -->
    <script src="http://libs.cartocdn.com/cartodb.js/v3/3.12/cartodb.js"></script>
    <div class="cartodb-overlay overlay-text desktop" style="z-index: 4; max-width: 500px; margin-left: 0px; margin-top: 0px; top: 0px; left: 1%; right: auto; bottom: auto; display: block; background-color: rgba(0, 0, 0, 0);">    <div class="content">    <div class="text widget_text" style="z-index: 4; color: rgb(0, 0, 0); text-align: left; font-size: 25px;"><strong>Travel time between NYC Metro Areas (Biking and Driving)</strong></div>    </div></div>

    <div class="cartodb-overlay overlay-text desktop" style="z-index: 4; max-width: 330px; margin-left: 0px; margin-top: 0px; top: 10%; left: 1%; right: auto; bottom: auto; display: block; background-color: rgba(0, 0, 0, 0);">    <div class="content">    <div class="text widget_text" style="z-index: 4; color: rgb(100, 100, 100); text-align: left; font-size: 12px;">This map presents travel times between  areas in NYC calculated by <a href="https://github.com/Project-OSRM/osrm-backend">OSRM</a>. <br><strong>Click on any area to make it the origin point.</strong></div> </div></div>

    <script>
      function main() {
        function createSelector(counties) {
          var $options = $(".layer_selector").find("li");
            var oncar = true
            var onbike = false
            $options.click(function(e) {
                  var $li = $(e.target);
                  selected = +$li.attr('data');
                  $options.removeClass('selected');
                  $li.addClass('selected');
                  if (selected === 'car') {
                      if (oncar) {
                          counties.on('featureClick', function(e, pos, pixel, data) {
                            var newSql = "SELECT durations_to_areas.* , round(t1.time,2) as time FROM durations_to_areas, (SELECT generate_series(1,2181) as cartodb_id,  unnest(times_car)::numeric as time FROM durations_to_areas WHERE durations_to_areas.name = " + data.name + ") as t1 Where durations_to_areas.cartodb_id = t1.cartodb_id";
                            counties.setSQL(newSql);
                          });
                          oncar = true;
                          onbike = false;
                      } else {
                          oldSql = counties.getSQL();
                          console.log(oldSql);
                          updateSql = oldSql.replace(/unnest\(times_bike\)/i, "unnest\(times_car\)");
                          console.log(updateSql);
                          counties.setSQL(updateSql);
                          counties.on('featureClick', function(e, pos, pixel, data) {
                            var newSql = "SELECT durations_to_areas.* , round(t1.time,2) as time FROM durations_to_areas, (SELECT generate_series(1,2181) as cartodb_id,  unnest(times_car)::numeric as time FROM durations_to_areas WHERE durations_to_areas.name = " + data.name + ") as t1 Where durations_to_areas.cartodb_id = t1.cartodb_id";
                            counties.setSQL(newSql);
                          });
                          oncar = true;
                          onbike = false;
                      }
                      //counties.render()
                  } else if (selected === 'bike') {
                      if (onbike) {
                          counties.on('featureClick', function(e, pos, pixel, data) {
                            var newSql = "SELECT durations_to_areas.* , round(t1.time,2) as time FROM durations_to_areas, (SELECT generate_series(1,2181) as cartodb_id,  unnest(times_bike)::numeric as time FROM durations_to_areas WHERE durations_to_areas.name = " + data.name + ") as t1 Where durations_to_areas.cartodb_id = t1.cartodb_id";
                            counties.setSQL(newSql);
                          });
                          oncar = false;
                          onbike = true;
                      } else {
                          oldSql = counties.getSQL();
                          console.log(oldSql);
                          updateSql = oldSql.replace(/unnest\(times_car\)/i, "unnest\(times_bike\)");
                          console.log(updateSql);
                          counties.setSQL(updateSql);
                          counties.on('featureClick', function(e, pos, pixel, data) {
                            var newSql = "SELECT durations_to_areas.* , round(t1.time,2) as time FROM durations_to_areas, (SELECT generate_series(1,2181) as cartodb_id,  unnest(times_bike)::numeric as time FROM durations_to_areas WHERE durations_to_areas.name = " + data.name + ") as t1 Where durations_to_areas.cartodb_id = t1.cartodb_id";
                            counties.setSQL(newSql);
                          });
                          oncar = false;
                          onbike = true;
                      }
                      //counties.render()
                  }
                });
              }
        // Add your code here
        var map = new L.Map('map', { zoomControl: false, center: [40.704301, -73.936658], zoom: 10 });
        var layer = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png').addTo(map);
        //var attribution = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', { attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors' }).addTo(map);
        var legend = new cdb.geo.ui.Legend({
           type: "choropleth",
           data: [{ value: "0 days"}, { value: "21+ days"},
             {name : 'color1', value: '#5E4FA2'},
{name : 'color2', value: '#4075B4'},
{name : 'color3', value: '#3990B9'},
{name : 'color4', value: '#48A0B2'},
{name : 'color5', value: '#56B1AB'},
{name : 'color6', value: '#65C1A5'},
{name : 'color7', value: '#72C7A4'},
{name : 'color8', value: '#80CCA4'},
{name : 'color9', value: '#8DD1A4'},
{name : 'color10', value: '#9AD6A4'},
{name : 'color11', value: '#A8DBA4'},
{name : 'color12', value: '#B1DFA2'},
{name : 'color13', value: '#BAE3A0'},
{name : 'color14', value: '#C3E69F'},
{name : 'color15', value: '#CCEA9D'},
{name : 'color16', value: '#D5EE9B'},
{name : 'color17', value: '#DEF199'},
{name : 'color18', value: '#E6F598'},
{name : 'color19', value: '#E9F69D'},
{name : 'color20', value: '#ECF7A2'},
{name : 'color21', value: '#EFF8A6'},
{name : 'color22', value: '#F2FAAB'},
{name : 'color23', value: '#F5FBB0'},
{name : 'color24', value: '#F8FCB5'},
{name : 'color25', value: '#FBFDBA'},
{name : 'color26', value: '#FEFEBE'},
{name : 'color27', value: '#FEFBB9'},
{name : 'color28', value: '#FEF8B3'},
{name : 'color29', value: '#FEF5AE'},
{name : 'color30', value: '#FEF1A8'},
{name : 'color31', value: '#FEEEA3'},
{name : 'color32', value: '#FEEB9D'},
{name : 'color33', value: '#FEE798'},
{name : 'color34', value: '#FEE492'},
{name : 'color35', value: '#FEE18C'},
{name : 'color36', value: '#FDDC88'},
{name : 'color37', value: '#FDD884'},
{name : 'color38', value: '#FDD380'},
{name : 'color39', value: '#FDCE7C'},
{name : 'color40', value: '#FDCA78'},
{name : 'color41', value: '#FDC574'},
{name : 'color42', value: '#FDC070'},
{name : 'color43', value: '#FDBC6C'},
{name : 'color44', value: '#FDB768'},
{name : 'color45', value: '#FDB264'},
{name : 'color46', value: '#FCAD60'},
{name : 'color47', value: '#FCA85E'},
{name : 'color48', value: '#FBA35B'},
{name : 'color49', value: '#FA9D59'},
{name : 'color50', value: '#F99856'},
{name : 'color51', value: '#F99254'},
{name : 'color52', value: '#F88D51'},
{name : 'color53', value: '#F7874F'},
{name : 'color54', value: '#F6824C'},
{name : 'color55', value: '#F67C4A'},
{name : 'color56', value: '#F57747'},
{name : 'color57', value: '#F47145'},
{name : 'color58', value: '#F36C43'},
{name : 'color59', value: '#F16844'},
{name : 'color60', value: '#EE6544'},
{name : 'color61', value: '#EC6145'},
{name : 'color62', value: '#EA5D46'},
{name : 'color63', value: '#E75A47'},
{name : 'color64', value: '#E55648'},
{name : 'color65', value: '#E25349'},
{name : 'color66', value: '#E04F4A'},
{name : 'color67', value: '#DE4B4B'},
{name : 'color68', value: '#DB484C'},
{name : 'color69', value: '#D9444D'},
{name : 'color70', value: '#D7414E'},
{name : 'color71', value: '#D43D4E'},
{name : 'color72', value: '#D0394D'},
{name : 'color73', value: '#CC344D'},
{name : 'color74', value: '#C8304C'},
{name : 'color75', value: '#C42C4B'},
{name : 'color76', value: '#C0274A'},
{name : 'color77', value: '#BD2349'},
{name : 'color78', value: '#B91F48'},
{name : 'color79', value: '#B51A47'},
{name : 'color80', value: '#B11646'},
{name : 'color81', value: '#AD1245'},
{name : 'color82', value: '#A90D44'},
{name : 'color83', value: '#A50943'},
{name : 'color84', value: '#A10542'},
{name : 'color85', value: '#9E0142'}
           ]
         });
         $('#map').append(legend.render().el);
        cartodb.createLayer(map, 'https://michellemho-carto.carto.com/api/v2/viz/2cf645fb-3955-449c-aecf-693320229a03/viz.json').addTo(map).on('done', function(layer) {
          var counties = layer.getSubLayer(0);
          counties.setInteractivity('cartodb_id, name, name, time')
          counties.setInteraction(true);
          counties.on('featureClick', function(e, pos, pixel, data) {
            var newSql = "SELECT durations_to_areas.* , round(t1.time,2) as time FROM durations_to_areas, (SELECT generate_series(1,2181) as cartodb_id,  unnest(times_car)::numeric as time FROM durations_to_areas WHERE durations_to_areas.name = " + data.name + ") as t1 Where durations_to_areas.cartodb_id = t1.cartodb_id";
              counties.setSQL(newSql);
            });
          createSelector(counties);

          })
        //map.render();
      }
      // you could use $(window).load(main);
      window.onload = main;
    </script>
  </body>
</html>
